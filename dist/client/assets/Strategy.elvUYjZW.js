import{j as e,r,u as s}from"./vendor.CaVeaJ46.js";import{C as a,b as t,c as n,a as o,M as i}from"./MainLayout.D8bZoW3k.js";import{B as d}from"./button.Dbb4DWlm.js";import{G as l}from"./data.BAESVmt3.js";import{A as m,a as c,b as u}from"./alert.CnbZrBuV.js";import{B as h,c as b,g as p,a as f}from"./BettingOptionsTable.UNlmRsON.js";import{R as x,B as y,X as g,Y as j,T as N,d as v,e as w}from"./charts.Cj5jtLqc.js";import{P,a as $,b as k}from"./popover.D82tYQ7w.js";import{j as M,I as S,k as R,l as q,m as E,a as O,n as I,B as K,X as F}from"./ui.CtzC-6wT.js";import{c as L}from"./index.DDEQmIFh.js";const T=(e,r,s,a,t,n,o,i,d,l)=>{const m=e.flatMap((e=>{const r=[],s=e.odds*e.winProb-1;return e.winProb>0&&s>0&&r.push({type:"単勝",horseName:`${e.number} ${e.name}`,odds:e.odds,prob:e.winProb,ev:s,frame1:e.frame,frame2:0,frame3:0,horse1:e.number,horse2:0,horse3:0}),r}));return a.forEach((r=>{const s=e.find((e=>e.number===r.horse1));if(!s)return;const a=Math.round((r.oddsMin+r.oddsMax)/2*10)/10,t=a*s.placeProb-1;s.placeProb>0&&t>0&&m.push({type:"複勝",horseName:`${s.number} ${s.name}`,odds:a,prob:s.placeProb,ev:t,frame1:s.frame,frame2:0,frame3:0,horse1:s.number,horse2:0,horse3:0})})),t.forEach((r=>{const s=e.filter((e=>e.frame===r.frame1)),a=e.filter((e=>e.frame===r.frame2));let t=0;if(r.frame1===r.frame2)for(let e=0;e<s.length;e++)for(let r=e+1;r<s.length;r++){const a=s[e],n=s[r];t+=a.winProb*((n.placeProb-n.winProb)/2),t+=n.winProb*((a.placeProb-a.winProb)/2)}else s.forEach((e=>{a.forEach((r=>{t+=e.winProb*((r.placeProb-r.winProb)/2),t+=r.winProb*((e.placeProb-e.winProb)/2)}))}));const n=r.odds*t-1;t>0&&n>0&&m.push({type:"枠連",horseName:`${r.frame1}-${r.frame2}`,frame1:r.frame1,frame2:r.frame2,frame3:0,odds:r.odds,prob:t,ev:n,horse1:0,horse2:0,horse3:0})})),n.forEach((r=>{const s=e.find((e=>e.number===r.horse1)),a=e.find((e=>e.number===r.horse2));if(!s||!a)return;let t=0;const n=(a.placeProb-a.winProb)/2;t+=s.winProb*n;const o=(s.placeProb-s.winProb)/2;t+=a.winProb*o;const i=r.odds*t-1;t>0&&i>0&&m.push({type:"馬連",horseName:`${s.number}-${a.number}`,frame1:s.frame,frame2:a.frame,frame3:0,horse1:s.number,horse2:a.number,horse3:0,odds:r.odds,prob:t,ev:i})})),o.forEach((r=>{const s=e.find((e=>e.number===r.horse1)),a=e.find((e=>e.number===r.horse2));if(!s||!a)return;let t=0;t+=s.winProb*((a.placeProb-a.winProb)/2),t+=s.winProb*((a.placeProb-a.winProb)/2),t+=a.winProb*((s.placeProb-s.winProb)/2),t+=(s.placeProb-s.winProb)/2*((a.placeProb-a.winProb)/2),t+=a.winProb*((s.placeProb-s.winProb)/2),t+=(s.placeProb-s.winProb)/2*((a.placeProb-a.winProb)/2);const n=Math.round((r.oddsMin+r.oddsMax)/2*10)/10,o=n*t-1;t>0&&o>0&&m.push({type:"ワイド",horseName:`${s.number}-${a.number}`,odds:n,prob:t,ev:o,frame1:s.frame,frame2:a.frame,frame3:0,horse1:s.number,horse2:a.number,horse3:0})})),i.forEach((r=>{const s=e.find((e=>e.number===r.horse1)),a=e.find((e=>e.number===r.horse2));if(!s||!a)return;const t=s.winProb*((a.placeProb-a.winProb)/2),n=r.odds*t-1;t>0&&n>0&&m.push({type:"馬単",horseName:`${s.number}→${a.number}`,frame1:s.frame,frame2:a.frame,frame3:0,horse1:s.number,horse2:a.number,horse3:0,odds:r.odds,prob:t,ev:n})})),d.forEach((r=>{const s=e.find((e=>e.number===r.horse1)),a=e.find((e=>e.number===r.horse2)),t=e.find((e=>e.number===r.horse3));if(!s||!a||!t)return;let n=0;n+=s.winProb*((a.placeProb-a.winProb)/2)*((t.placeProb-t.winProb)/2),n+=s.winProb*((t.placeProb-t.winProb)/2)*((a.placeProb-a.winProb)/2),n+=a.winProb*((s.placeProb-s.winProb)/2)*((t.placeProb-t.winProb)/2),n+=a.winProb*((t.placeProb-t.winProb)/2)*((s.placeProb-s.winProb)/2),n+=t.winProb*((s.placeProb-s.winProb)/2)*((a.placeProb-a.winProb)/2),n+=t.winProb*((a.placeProb-a.winProb)/2)*((s.placeProb-s.winProb)/2);const o=r.odds*n-1;n>0&&o>0&&m.push({type:"３連複",horseName:`${s.number}-${a.number}-${t.number}`,frame1:s.frame,frame2:a.frame,frame3:t.frame,horse1:s.number,horse2:a.number,horse3:t.number,odds:r.odds,prob:n,ev:o})})),l.forEach((r=>{const s=e.find((e=>e.number===r.horse1)),a=e.find((e=>e.number===r.horse2)),t=e.find((e=>e.number===r.horse3));if(!s||!a||!t)return;const n=s.winProb*((a.placeProb-a.winProb)/2)*((t.placeProb-t.winProb)/2),o=r.odds*n-1;n>0&&o>0&&m.push({type:"３連単",horseName:`${s.number}→${a.number}→${t.number}`,frame1:s.frame,frame2:a.frame,frame3:t.frame,horse1:s.number,horse2:a.number,horse3:t.number,odds:r.odds,prob:n,ev:o})})),(e=>{const a=(e=>{const r={"複勝":{min:0,max:2},"単勝":{min:0,max:3},"枠連":{min:0,max:4},"ワイド":{min:0,max:4},"馬連":{min:0,max:6},"馬単":{min:0,max:8},"３連複":{min:0,max:12},"３連単":{min:0,max:16}},s=e.reduce(((e,r)=>(e[r.type]||(e[r.type]=[]),e[r.type].push(r),e)),{});let a=[];return Object.entries(s).forEach((([e,s])=>{const t=r[e],n=Math.min(s.length,Math.max(t.min,Math.min(t.max,s.length)));a=a.concat(s.slice(0,n))})),a.sort(((e,r)=>r.ev-e.ev))})(e.filter((e=>{const r=(e=>{switch(e){case"単勝":return 1.5;case"複勝":default:return 1;case"枠連":case"ワイド":return 2;case"馬連":return 3;case"馬単":return 4;case"３連複":return 6;case"３連単":return 8}})(e.type),a=Math.max(1,Math.pow(s,.5)*Math.pow(r,1.5)),t=Math.max(.005,1/(s*r)),n=Math.max(.3,Math.pow(r,.5)/Math.pow(s,.5));return e.odds>=a&&e.prob>=t&&e.ev>=n})).sort(((e,r)=>r.ev-e.ev))),t=a.map((()=>1/a.length));return a.map(((e,s)=>({type:e.type,horses:[e.horseName],horseName:e.horseName,stake:Number((r*t[s]).toFixed(1)),expectedReturn:Number((r*t[s]*e.odds).toFixed(1)),probability:e.prob,frame1:e.frame1,frame2:e.frame2,frame3:e.frame3,horse1:e.horse1,horse2:e.horse2,horse3:e.horse3}))).sort(((e,r)=>{const s={"単勝":1,"複勝":2,"枠連":3,"ワイド":4,"馬連":5,"馬単":6,"３連複":7,"３連単":8},a=s[e.type]-s[r.type];return 0!==a?a:r.stake-e.stake}))})(m)};function C({winProbs:r,placeProbs:s,horses:i,budget:d,riskRatio:l}){const m=(e,r=5)=>{const s=i.map((r=>({name:`${r.number}. ${r.name}`,probability:e[r.id]||0,horseNumber:r.number}))).sort(((e,r)=>r.probability-e.probability)).filter((e=>e.probability>0));for(;s.length<r;)s.push({name:"",probability:0,horseNumber:-1});return s.slice(0,r)},c=m(r),u=m(s),h=({data:r,title:s})=>e.jsxs(a,{className:"flex-1 bg-zinc-900/50 border-zinc-800",children:[e.jsx(t,{children:e.jsx(n,{className:"text-zinc-100",children:s})}),e.jsx(o,{children:e.jsx("div",{className:"h-[250px]",children:e.jsx(x,{width:"100%",height:"100%",children:e.jsxs(y,{data:r,layout:"vertical",margin:{right:20},children:[e.jsx(g,{type:"number",domain:[0,100],stroke:"rgba(161, 161, 170, 1.0)",fontSize:12,tickFormatter:e=>`${e}`,unit:"%"}),e.jsx(j,{dataKey:"name",type:"category",width:130,stroke:"rgba(161, 161, 170, 1.0)",fontSize:12,interval:0,tickFormatter:e=>{if(!e)return"　";const[r,s]=e.split(". ");return`${r}.${s}`}}),e.jsx(N,{formatter:e=>[`${e.toFixed(1)}%`,"確率"],labelFormatter:e=>e||"",contentStyle:{backgroundColor:"rgba(24, 24, 27, 0.9)",border:"1px solid rgba(63, 63, 70, 0.5)",borderRadius:"6px",color:"#ffffff"},labelStyle:{color:"#ffffff"},itemStyle:{color:"#ffffff"}}),e.jsx(v,{dataKey:"probability",radius:[0,4,4,0],children:r.map(((r,s)=>{return e.jsx(w,{fill:r.name?(a=r.probability,`rgba(14, 232, 159, ${.3+a/100*.7})`):"transparent"},`cell-${s}`);var a}))})]})})})})]});return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(a,{className:"w-full bg-zinc-900/50 border-zinc-800",children:[e.jsx(t,{children:e.jsx(n,{className:"text-zinc-100",children:"投資設定"})}),e.jsx(o,{children:e.jsxs("div",{className:"flex justify-around",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-zinc-400",children:"予算:"}),e.jsxs("span",{className:"text-xl font-bold text-zinc-100",children:[d.toLocaleString(),"円"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-zinc-400",children:"リスクリワード:"}),e.jsx("span",{className:"text-xl font-bold text-zinc-100",children:l})]})]})})]}),e.jsxs("div",{className:"grid md:grid-cols-2 lg:grid-cols-1 gap-4",children:[e.jsx(h,{data:c,title:"単勝予想確率 上位5頭"}),e.jsx(h,{data:u,title:"複勝予想確率 上位5頭"})]})]})}const z=r.forwardRef((({className:r,...s},a)=>e.jsx(M,{className:L("grid gap-2",r),...s,ref:a})));z.displayName=M.displayName;const B=r.forwardRef((({className:r,...s},a)=>e.jsx(S,{ref:a,className:L("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),...s,children:e.jsx(R,{className:"flex items-center justify-center",children:e.jsx(q,{className:"h-2.5 w-2.5 fill-current text-current"})})})));B.displayName=S.displayName;const D=O("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),J=r.forwardRef((({className:r,...s},a)=>e.jsx(E,{ref:a,className:L(D(),r),...s})));J.displayName=E.displayName;const _=O("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function U({className:r,variant:s,...a}){return e.jsx("div",{className:L(_({variant:s}),r),...a})}const A=r.memo((function({recommendedBets:i,budget:h,riskRatio:x,onStrategyChange:y}){const{id:g}=s();r.useRef(0);const[j,N]=r.useState({strategy:null,isLoading:!1,error:null,isRequesting:!1,requestId:void 0}),[v,w]=r.useState(0),[M,S]=r.useState(0),[R,q]=r.useState([]);r.useEffect((()=>{}),[]);const{data:E}=l({queryKey:[`/api/horses/${g}`],enabled:!!g}),{data:O}=l({queryKey:[`/api/tan-odds-history/latest/${g}`],enabled:!!g}),{data:L}=l({queryKey:[`/api/fuku-odds/latest/${g}`],enabled:!!g}),{data:C}=l({queryKey:[`/api/wakuren-odds/latest/${g}`],enabled:!!g}),{data:D}=l({queryKey:[`/api/umaren-odds/latest/${g}`],enabled:!!g}),{data:_}=l({queryKey:[`/api/wide-odds/latest/${g}`],enabled:!!g}),{data:A}=l({queryKey:[`/api/umatan-odds/latest/${g}`],enabled:!!g}),{data:H}=l({queryKey:[`/api/sanrenpuku-odds/latest/${g}`],enabled:!!g}),{data:G}=l({queryKey:[`/api/sanrentan-odds/latest/${g}`],enabled:!!g}),W=new URLSearchParams(window.location.search).get("winProbs")||"{}",X=new URLSearchParams(window.location.search).get("placeProbs")||"{}",Q=JSON.parse(W),Z=JSON.parse(X),ee=r.useCallback((async()=>{var e;if(Date.now()-v<5e3)return void N((e=>({...e,error:"再分析は5秒以上の間隔を空けてください"})));if(j.isRequesting||!(null==i?void 0:i.length)||!E)return;const r=crypto.randomUUID();try{N((e=>({...e,isRequesting:!0,isLoading:!0,error:null,requestId:r})));const s=T(E.map((e=>{var r;return{name:e.name,odds:Number((null==(r=null==O?void 0:O.find((r=>Number(r.horseId)===e.number)))?void 0:r.odds)||0),winProb:Q[e.id]/100,placeProb:Z[e.id]/100,frame:e.frame,number:e.number}})),h,x,(null==L?void 0:L.map((e=>({horse1:Number(e.horseId),oddsMin:Number(e.oddsMin),oddsMax:Number(e.oddsMax)}))))||[],(null==C?void 0:C.map((e=>({frame1:e.frame1,frame2:e.frame2,odds:Number(e.odds)}))))||[],(null==D?void 0:D.map((e=>({horse1:Number(e.horse1),horse2:Number(e.horse2),odds:Number(e.odds)}))))||[],(null==_?void 0:_.map((e=>({horse1:Number(e.horse1),horse2:Number(e.horse2),oddsMin:Number(e.oddsMin),oddsMax:Number(e.oddsMax)}))))||[],(null==A?void 0:A.map((e=>({horse1:Number(e.horse1),horse2:Number(e.horse2),odds:Number(e.odds)}))))||[],(null==H?void 0:H.map((e=>({horse1:Number(e.horse1),horse2:Number(e.horse2),horse3:Number(e.horse3),odds:Number(e.odds)}))))||[],(null==G?void 0:G.map((e=>({horse1:Number(e.horse1),horse2:Number(e.horse2),horse3:Number(e.horse3),odds:Number(e.odds)}))))||[]),a=b(s,E.map((e=>{var r;return{name:e.name,odds:Number((null==(r=null==O?void 0:O.find((r=>Number(r.horseId)===e.number)))?void 0:r.odds)||0),winProb:Q[e.id]/100,placeProb:Z[e.id]/100,frame:e.frame,number:e.number}}))),t={horses:E.map((e=>{var r;return{name:e.name,odds:Number((null==(r=null==O?void 0:O.find((r=>Number(r.horseId)===e.number)))?void 0:r.odds)||0),winProb:Q[e.id],placeProb:Z[e.id],frame:e.frame,number:e.number}})),bettingOptions:(null==i?void 0:i.map((e=>({type:e.type,horseName:e.horses.join(e.type.includes("単")?"→":"-"),odds:e.expectedReturn/e.stake,prob:e.probability,ev:e.expectedReturn-e.stake,frame1:e.frame1||0,frame2:e.frame2||0,frame3:e.frame3||0,horse1:e.horse1||0,horse2:e.horse2||0,horse3:e.horse3||0}))))||[],conditionalProbabilities:a.map((e=>({condition:{type:e.condition.type,horses:e.condition.horses},target:{type:e.target.type,horses:e.target.horses},probability:e.probability}))),raceId:"default-race-id"},n=await p([],h,t,x);if(!(null==(e=n.strategy)?void 0:e.bettingTable))throw new Error("Invalid strategy response format");if(!g)return;V(n.strategy,{budget:h,riskRatio:x,recommendedBets:i,feedbacks:R},g),w(Date.now()),N((e=>e.requestId!==r?e:{...e,strategy:n.strategy,isLoading:!1,isRequesting:!1})),y(n.strategy)}catch(s){N((e=>e.requestId!==r?e:{...e,error:"AIからの戦略取得に失敗しました",isLoading:!1,isRequesting:!1}))}}),[g,h,x,i,E,v,j.isRequesting,R,y,L,C,D,_,A,H,G]);r.useEffect((()=>{if(!(null==i?void 0:i.length))return;if(!g)return;const e=Y(g);if(e){const{strategy:r,params:s}=e;if(s.budget===h&&s.riskRatio===x&&JSON.stringify(s.recommendedBets)===JSON.stringify(i))return void N((e=>({...e,strategy:r})))}j.strategy||j.isRequesting||ee()}),[g,h,x,i]),r.useEffect((()=>{if(0===v)return;const e=()=>{const r=Math.max(0,5e3-(Date.now()-v));S(r),r>0&&setTimeout(e,100)};return e(),()=>{S(0)}}),[v]);const re=r.useMemo((()=>j.strategy?e.jsx(f,{strategy:j.strategy,totalBudget:h}):null),[j.strategy,h]),se=e=>{q((r=>[...r,e]))};return j.isLoading?e.jsxs(a,{children:[e.jsx(t,{children:e.jsxs(n,{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-5 w-5 animate-pulse"}),"AI戦略分析中"]})}),e.jsx(o,{children:e.jsxs("div",{className:"space-y-4",children:[null==i?void 0:i.slice(0,3).map(((r,s)=>e.jsx("div",{className:"border rounded-lg p-3 animate-pulse bg-gradient-to-r from-background to-muted",style:{animationDelay:200*s+"ms",opacity:1-.2*s},children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-16 h-4 bg-muted rounded animate-pulse"}),e.jsx("div",{className:"w-24 h-4 bg-muted rounded animate-pulse"})]}),e.jsx("div",{className:"w-16 h-4 bg-muted rounded animate-pulse"})]})},s))),e.jsxs("div",{className:"flex items-center justify-center mt-6 text-muted-foreground",children:[e.jsx("span",{className:"loading loading-spinner loading-md mr-2"}),"AIが最適な投資戦略を分析中..."]})]})})]}):j.error?e.jsxs("div",{className:"space-y-4",children:[e.jsxs(m,{variant:"destructive",children:[e.jsx(I,{className:"h-4 w-4"}),e.jsx(c,{children:j.error})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(d,{onClick:ee,disabled:j.isLoading||j.isRequesting||M>0,className:"gap-2",children:j.isLoading?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"h-4 w-4"}),"戦略を再分析"]}):M>0?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"h-4 w-4"}),Math.ceil(M/1e3),"秒後に再分析可能"]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"h-4 w-4"}),"戦略を再分析"]})})})]}):j.strategy?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsxs(P,{children:[e.jsx($,{asChild:!0,children:e.jsxs(d,{variant:"outline",className:"gap-2",children:[e.jsx(K,{className:"h-4 w-4"}),"戦略の調整"]})}),e.jsx(k,{className:"w-80",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium",children:"戦略の調整"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(J,{children:"リスク選好"}),e.jsxs(z,{onValueChange:e=>{se({type:e,details:{}})},children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(B,{value:"MORE_RISK",id:"more-risk"}),e.jsx(J,{htmlFor:"more-risk",children:"よりリスクを取る"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(B,{value:"LESS_RISK",id:"less-risk"}),e.jsx(J,{htmlFor:"less-risk",children:"よりリスクを抑える"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(J,{children:"注目したい馬"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:null==E?void 0:E.map((r=>e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>se({type:"FOCUS_HORSE",details:{horseNumbers:[r.number],description:r.name}}),children:[r.number,"番"]},r.number)))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(J,{children:"重視したい券種"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:["単勝","複勝","枠連","ワイド","馬連","馬単","３連複","３連単"].map((r=>e.jsx(d,{variant:"outline",size:"sm",onClick:()=>se({type:"PREFER_BET_TYPE",details:{betType:r}}),children:r},r)))})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(d,{variant:"outline",onClick:()=>{q([])},disabled:0===R.length,children:"調整をリセット"}),e.jsx(d,{onClick:()=>{ee()},disabled:0===R.length,children:"フィードバックを反映して再分析"})]})]})})]}),e.jsx(d,{onClick:ee,disabled:j.isLoading||j.isRequesting||M>0,className:"gap-2",children:j.isLoading?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"h-4 w-4 animate-pulse"}),"分析中..."]}):M>0?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"h-4 w-4"}),Math.ceil(M/1e3),"秒後に再分析可能"]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"h-4 w-4"}),"戦略を再分析"]})})]}),R.length>0&&e.jsxs("div",{className:"rounded-lg border p-4 space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"反映された調整"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:R.map(((r,s)=>{var a,t;return e.jsxs(U,{variant:"secondary",className:"flex items-center gap-1",children:["FOCUS_HORSE"===r.type&&`${null==(a=r.details.horseNumbers)?void 0:a.join(",")}番に注目`,"AVOID_HORSE"===r.type&&`${null==(t=r.details.horseNumbers)?void 0:t.join(",")}番を避ける`,"PREFER_BET_TYPE"===r.type&&`${r.details.betType}を重視`,"AVOID_BET_TYPE"===r.type&&`${r.details.betType}を避ける`,"MORE_RISK"===r.type&&"よりリスクを取る","LESS_RISK"===r.type&&"よりリスクを抑える",e.jsx(d,{variant:"ghost",size:"sm",className:"h-4 w-4 p-0 hover:bg-transparent",onClick:()=>(e=>{q((r=>r.filter(((r,s)=>s!==e))))})(s),children:e.jsx(F,{className:"h-3 w-3"})})]},s)}))})]}),re]}):0===(null==i?void 0:i.length)?e.jsxs(m,{children:[e.jsx(I,{className:"h-4 w-4"}),e.jsx(u,{children:"最適な馬券が見つかりませんでした"}),e.jsxs(c,{children:["予算とリスク設定を調整して、再度試してください。",e.jsxs("ul",{className:"list-disc list-inside mt-2 text-sm",children:[e.jsx("li",{children:"予算を増やす"}),e.jsx("li",{children:"リスク設定を下げる"}),e.jsx("li",{children:"的中確率の見直し"})]})]})]}):null})),V=(e,r,s)=>{try{const a=`strategy-${s}`,t=`strategy-params-${s}`;sessionStorage.setItem(a,JSON.stringify({strategy:e,timestamp:Date.now()})),sessionStorage.setItem(t,JSON.stringify({...r,timestamp:Date.now()}))}catch(a){}},Y=e=>{try{const r=`strategy-${e}`,s=`strategy-params-${e}`,a=sessionStorage.getItem(r),t=sessionStorage.getItem(s);if(!a||!t)return null;const{strategy:n,timestamp:o}=JSON.parse(a),{timestamp:i,...d}=JSON.parse(t);return Date.now()-o>3e5?null:{strategy:n,params:d}}catch(r){return null}};function H(){const{id:a}=s(),t=new URLSearchParams(window.location.search),n=Number(t.get("budget"))||0,o=Number(t.get("risk"))||1,b=t.get("winProbs")||"{}",p=t.get("placeProbs")||"{}",f=r.useMemo((()=>{try{return JSON.parse(b)}catch(e){return{}}}),[b]),x=r.useMemo((()=>{try{return JSON.parse(p)}catch(e){return{}}}),[p]),{data:y}=l({queryKey:[`/api/horses/${a}`],enabled:!!a}),{data:g}=l({queryKey:[`/api/tan-odds-history/latest/${a}`],enabled:!!a}),{data:j}=l({queryKey:[`/api/fuku-odds/latest/${a}`],enabled:!!a}),{data:N}=l({queryKey:[`/api/wakuren-odds/latest/${a}`],enabled:!!a}),{data:v}=l({queryKey:[`/api/umaren-odds/latest/${a}`],enabled:!!a}),{data:w}=l({queryKey:[`/api/wide-odds/latest/${a}`],enabled:!!a}),{data:P}=l({queryKey:[`/api/umatan-odds/latest/${a}`],enabled:!!a}),{data:$}=l({queryKey:[`/api/sanrenpuku-odds/latest/${a}`],enabled:!!a}),{data:k}=l({queryKey:[`/api/sanrentan-odds/latest/${a}`],enabled:!!a}),M=r.useMemo((()=>[`/api/betting-strategy/${a}`,{budget:n,riskRatio:o,winProbs:f,placeProbs:x}]),[a,n,o,f,x]),{data:S,isLoading:R}=l({queryKey:M,queryFn:async()=>{if(!(y&&g&&j&&N&&v&&w&&P&&$&&k))return[];const e=y.map((e=>{var r,s;return{name:e.name,odds:Number((null==(r=g.find((r=>Number(r.horseId)===e.number)))?void 0:r.odds)||0),fukuOdds:Number((null==(s=j.find((r=>Number(r.horseId)===e.number)))?void 0:s.oddsMin)||0),winProb:f[e.id]/100,placeProb:x[e.id]/100,frame:e.frame,number:e.number}})),r=N.map((e=>({frame1:e.frame1,frame2:e.frame2,odds:Number(e.odds)}))),s=v.map((e=>({horse1:e.horse1,horse2:e.horse2,odds:Number(e.odds)}))),a=w.map((e=>({horse1:e.horse1,horse2:e.horse2,oddsMin:Number(e.oddsMin),oddsMax:Number(e.oddsMax)}))),t=P.map((e=>({horse1:e.horse1,horse2:e.horse2,odds:Number(e.odds)}))),i=$.map((e=>({horse1:e.horse1,horse2:e.horse2,horse3:e.horse3,odds:Number(e.odds)}))),d=k.map((e=>({horse1:e.horse1,horse2:e.horse2,horse3:e.horse3,odds:Number(e.odds)}))),l=(null==j?void 0:j.map((e=>({horse1:e.horseId,oddsMin:Number(e.oddsMin),oddsMax:Number(e.oddsMax)}))))||[];return T(e,n,o,l,r,s,a,t,i,d)},enabled:!!(a&&y&&g&&j&&N&&v&&w&&P&&$&&k&&n>0&&Object.keys(f).length>0),staleTime:3e4,cacheTime:6e4,retry:2,retryDelay:e=>Math.min(1e3*2**e,1e4),refetchOnWindowFocus:!1,refetchOnReconnect:!1});r.useEffect((()=>{}),[n,o,f,x,b,p]);const{data:q}=l({queryKey:[`/api/races/${a}`],enabled:!!a}),[E,O]=r.useState(null),K=r.useMemo((()=>S),[JSON.stringify(S)]);r.useMemo((()=>{const e=(null==K?void 0:K.reduce(((e,r)=>e+r.stake),0))||0,r=(null==K?void 0:K.map((r=>({weight:e?r.stake/e:0,expectedPayout:r.expectedReturn*r.probability}))))||[],s=r.reduce(((e,r)=>e+r.expectedPayout),0),a=e>0?s/e-1:0,t=e>0?`+${(100*a).toFixed(1)}%`:"0%";return{totalInvestment:e,betDetails:r,expectedTotalPayout:s,totalExpectedReturn:a,expectedROI:t}}),[K]);const F=r.useMemo((()=>{var e;return(null==(e=null==E?void 0:E.recommendations)?void 0:e.map((e=>({type:e.type,horses:e.horses,horseName:e.horses.join("-"),stake:0,expectedReturn:e.odds||0,probability:Number(e.probability)}))))||[]}),[JSON.stringify(null==E?void 0:E.recommendations)]);return y?!n||n<=0?e.jsx(i,{children:e.jsxs(m,{variant:"destructive",children:[e.jsx(I,{className:"h-4 w-4"}),e.jsx(c,{children:"予算が設定されていません。"})]})}):Object.keys(f).length>0||Object.keys(x).length>0?0===(null==S?void 0:S.length)?e.jsx(i,{children:e.jsxs(m,{children:[e.jsx(I,{className:"h-4 w-4"}),e.jsx(u,{children:"最適な馬券が見つかりませんでした"}),e.jsxs(c,{children:["以下の点を確認して、再度試してください：",e.jsxs("ul",{className:"list-disc list-inside mt-2",children:[e.jsxs("li",{children:["予算: ",n.toLocaleString(),"円"]}),e.jsxs("li",{children:["リスク設定: ",o]})]}),e.jsx("div",{className:"mt-2",children:e.jsx(d,{variant:"outline",onClick:()=>window.history.back(),className:"mt-2",children:"戻る"})})]})]})}):e.jsx(i,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"rounded-lg border border-border/50 bg-card/30 backdrop-blur-sm p-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:(null==q?void 0:q.name)||"レース名を読み込み中..."}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[null==q?void 0:q.venue," - ",(null==q?void 0:q.startTime)?new Date(q.startTime).toLocaleString("ja-JP"):""]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsx(A,{recommendedBets:S,budget:n,riskRatio:o,onStrategyChange:O}),y&&e.jsx(C,{winProbs:f,placeProbs:x,horses:y,budget:n,riskRatio:o})]}),e.jsx("div",{className:"lg:col-span-1",children:S&&S.length>0&&e.jsx("div",{className:"lg:sticky lg:top-4",children:e.jsx(h,{bettingOptions:S,selectedBets:F})})})]})]})}):e.jsx(i,{children:e.jsxs(m,{variant:"destructive",children:[e.jsx(I,{className:"h-4 w-4"}),e.jsx(c,{children:"確率データが不足しています。確率入力画面からやり直してください。"})]})}):e.jsx(i,{children:e.jsxs(m,{variant:"destructive",children:[e.jsx(I,{className:"h-4 w-4"}),e.jsx(c,{children:"レースデータの読み込みに失敗しました。"})]})})}export{H as default};
