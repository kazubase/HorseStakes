import{r as e,j as r,u as t,h as s}from"./vendor.CaVeaJ46.js";import{C as a,b as o,c as n,a as i,M as l}from"./MainLayout.D8bZoW3k.js";import{I as d,J as m,G as c,K as h,C as u}from"./data.BAESVmt3.js";import{S as b,c as p,B as f,h as g,b as x,d as y,e as w,w as v,p as N,g as j,s as P,l as k,f as $,i as M,a as E,j as O}from"./BettingOptionsTable.UNlmRsON.js";import{A as S,a as R}from"./alert.CnbZrBuV.js";import{B as L}from"./button.Dbb4DWlm.js";import{c as I}from"./index.DDEQmIFh.js";import{s as A,L as T,n as B,e as F,h as C,u as q,M as z,v as U,w as K,x as J,y as V}from"./ui.CtzC-6wT.js";import"./charts.Cj5jtLqc.js";import"./popover.D82tYQ7w.js";const D=e=>"number"==typeof e?e:parseFloat(e.replace("%",""))/100,_=()=>{var e;const r=null==(e=document.querySelector('meta[name="csrf-token"]'))?void 0:e.content;if(!r)throw new Error("CSRFトークンが見つかりません");return r};const W=e.memo((({budget:t,riskRatio:s,horses:l,winProbs:d,placeProbs:m})=>{const c=e.useCallback((e=>({1:"bg-white text-black border border-gray-200",2:"bg-black text-white",3:"bg-red-600 text-white",4:"bg-blue-600 text-white",5:"bg-yellow-400 text-black",6:"bg-green-600 text-white",7:"bg-orange-500 text-white",8:"bg-pink-400 text-white"}[e]||"bg-gray-200")),[]);return r.jsxs(a,{className:"overflow-hidden bg-gradient-to-br from-background to-primary/5",children:[r.jsxs(o,{className:"relative pb-4",children:[r.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-primary/10 via-background/5 to-transparent opacity-50"}),r.jsx(n,{className:"relative",children:"予想設定"})]}),r.jsxs(i,{className:"p-0",children:[r.jsx("div",{className:"p-4 bg-gradient-to-b from-primary/5",children:r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxs("div",{className:"bg-background/80 backdrop-blur-sm rounded-xl p-3 shadow-lg border border-primary/10",children:[r.jsxs("p",{className:"text-base sm:text-lg font-bold tracking-tight bg-gradient-to-br from-foreground to-foreground/70 bg-clip-text text-transparent truncate",children:["￥",t.toLocaleString()]}),r.jsx("p",{className:"text-xs text-muted-foreground mt-1 font-medium",children:"予算"})]}),r.jsxs("div",{className:"bg-background/80 backdrop-blur-sm rounded-xl p-3 shadow-lg border border-primary/10",children:[r.jsxs("p",{className:"text-base sm:text-lg font-bold tracking-tight bg-gradient-to-br from-foreground to-foreground/70 bg-clip-text text-transparent",children:["×",s.toFixed(1)]}),r.jsx("p",{className:"text-xs text-muted-foreground mt-1 font-medium",children:"リスクリワード"})]})]})}),r.jsx("div",{className:"divide-y divide-border/30",children:l&&l.length>0?l.map((e=>({...e,winProb:Number(d[e.id])/100||0,placeProb:Number(m[e.id])/100||0}))).filter((e=>e.winProb>0||e.placeProb>0)).sort(((e,r)=>r.winProb!==e.winProb?r.winProb-e.winProb:r.placeProb-e.placeProb)).map((e=>r.jsxs("div",{className:"relative group",children:[r.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-primary/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"}),r.jsxs("div",{className:"relative flex items-center px-4 py-3",children:[r.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[r.jsx("div",{className:`\n                        w-8 h-8 flex items-center justify-center rounded-lg font-bold shadow-sm\n                        ${c(e.frame)}\n                      `,children:e.number}),r.jsx("span",{className:"text-sm font-medium",children:e.name})]}),r.jsxs("div",{className:"flex gap-6",children:[r.jsxs("div",{className:"text-right",children:[r.jsxs("p",{className:"text-sm font-bold "+(e.winProb>=.3?"text-primary":e.winProb>=.2?"text-primary/80":"text-muted-foreground"),children:[(100*e.winProb).toFixed(0),"%"]}),r.jsx("p",{className:"text-[10px] text-muted-foreground font-medium",children:"単勝"})]}),r.jsxs("div",{className:"text-right",children:[r.jsxs("p",{className:"text-sm font-bold "+(e.placeProb>=.75?"text-primary":e.placeProb>=.5?"text-primary/80":"text-muted-foreground"),children:[(100*e.placeProb).toFixed(0),"%"]}),r.jsx("p",{className:"text-[10px] text-muted-foreground font-medium",children:"複勝"})]})]})]})]},e.id))):r.jsxs("div",{className:"flex justify-center items-center h-32",children:[r.jsx(b,{className:"w-4 h-4 mr-2"}),r.jsx("span",{className:"text-sm text-muted-foreground",children:"読込中..."})]})})]})]})})),X=e.memo((({isLoading:e,data:t})=>r.jsxs(a,{className:"overflow-hidden bg-gradient-to-br from-black/40 to-primary/5",children:[r.jsxs(o,{className:"relative pb-4",children:[r.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-primary/10 via-background/5 to-transparent opacity-30"}),r.jsx(n,{className:"relative",children:"分析結果"})]}),r.jsx(i,{children:e?r.jsxs("div",{className:"flex justify-center items-center p-4",children:[r.jsx(b,{className:"w-4 h-4"}),r.jsx("span",{className:"ml-2 text-muted-foreground",children:"分析中..."})]}):t?r.jsx("div",{className:"space-y-4",children:t.summary.keyInsights.map(((e,t)=>r.jsxs("div",{className:"relative overflow-hidden group bg-black/40 backdrop-blur-sm rounded-lg border border-primary/10",children:[r.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-primary/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"}),r.jsx("div",{className:"relative p-4",children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx("div",{className:"w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center shrink-0",children:r.jsx("span",{className:"text-xs font-medium text-primary",children:t+1})}),"string"==typeof e?r.jsx("p",{className:"text-sm leading-relaxed",children:e}):r.jsxs("div",{className:"space-y-2 flex-1",children:[r.jsx("h4",{className:"text-sm font-medium text-primary",children:e.strategy}),r.jsx("p",{className:"text-sm leading-relaxed",children:e.details}),r.jsx("div",{className:"flex justify-between text-xs mt-2",children:r.jsxs("span",{className:"text-muted-foreground",children:["リスク: ",r.jsx("span",{className:"font-medium "+("低"===e.riskLevel?"text-green-400":"中"===e.riskLevel?"text-yellow-400":"text-red-400"),children:e.riskLevel})]})})]})]})})]},t)))}):null})]})));function Y({initialSidebarOpen:a=!1}){var o;const{id:n}=t();s();const[i,l]=d(g),[h,u]=d(x);e.useState(!1);const[,b]=d(y),[,j]=d(w),P=m(w);e.useState(!1);const[,k]=d(v),[,$]=d(N),[M,E]=e.useState(a),[O,q]=e.useState("settings");e.useEffect((()=>{const e=()=>{E(!0)},r=()=>{E(!0)};return window.addEventListener("openAnalysisSidebar",e),window.addEventListener("navigateToAnalysisWithSidebar",r),()=>{window.removeEventListener("openAnalysisSidebar",e),window.removeEventListener("navigateToAnalysisWithSidebar",r)}}),[]),e.useEffect((()=>{E(a)}),[a]);const z=Number(new URLSearchParams(window.location.search).get("budget"))||1e4,U=Number(new URLSearchParams(window.location.search).get("risk"))||1,K=new URLSearchParams(window.location.search).get("winProbs")||"{}",J=new URLSearchParams(window.location.search).get("placeProbs")||"{}",V=JSON.parse(K),D=JSON.parse(J),{data:Y,isError:H}=c({queryKey:[`/api/horses/${n}`],enabled:!!n}),{data:G}=c({queryKey:[`/api/tan-odds-history/latest/${n}`],enabled:!!n,refetchInterval:6e5}),{data:Z}=c({queryKey:[`/api/fuku-odds/latest/${n}`],enabled:!!n,refetchInterval:6e5}),{data:Q}=c({queryKey:[`/api/wakuren-odds/latest/${n}`],enabled:!!n,refetchInterval:6e5}),{data:ee}=c({queryKey:[`/api/umaren-odds/latest/${n}`],enabled:!!n,refetchInterval:6e5}),{data:re}=c({queryKey:[`/api/wide-odds/latest/${n}`],enabled:!!n,refetchInterval:6e5}),{data:te}=c({queryKey:[`/api/umatan-odds/latest/${n}`],enabled:!!n,refetchInterval:6e5}),{data:se}=c({queryKey:[`/api/sanrenpuku-odds/latest/${n}`],enabled:!!n,refetchInterval:6e5}),{data:ae}=c({queryKey:[`/api/sanrentan-odds/latest/${n}`],enabled:!!n,refetchInterval:6e5}),{data:oe}=c({queryKey:["betting-options",{horsesLength:null==i?void 0:i.length,latestOddsLength:null==G?void 0:G.length,latestFukuOddsLength:null==Z?void 0:Z.length,wakurenOddsLength:null==Q?void 0:Q.length,umarenOddsLength:null==ee?void 0:ee.length,wideOddsLength:null==re?void 0:re.length,umatanOddsLength:null==te?void 0:te.length,sanrenpukuOddsLength:null==se?void 0:se.length,sanrentanOddsLength:null==ae?void 0:ae.length,budget:z,riskRatio:U}],queryFn:()=>(null==i?void 0:i.length)&&(null==G?void 0:G.length)&&(null==Z?void 0:Z.length)&&(null==Q?void 0:Q.length)&&(null==ee?void 0:ee.length)&&(null==re?void 0:re.length)&&(null==te?void 0:te.length)&&(null==se?void 0:se.length)&&(null==ae?void 0:ae.length)?((e,r,t,s,a,o,n,i,l,d)=>{const m=e.flatMap((e=>{const r=[],t=e.odds*e.winProb;return e.winProb>0&&t>1&&r.push({type:"単勝",horseName:`${e.number} ${e.name}`,odds:e.odds,prob:e.winProb,ev:t,frame1:e.frame,frame2:0,frame3:0,horse1:e.number,horse2:0,horse3:0}),r}));return s.forEach((r=>{const t=e.find((e=>e.number===r.horse1));if(!t)return;const s=Math.round((r.oddsMin+r.oddsMax)/2*10)/10,a=s*t.placeProb;t.placeProb>0&&a>1&&m.push({type:"複勝",horseName:`${t.number} ${t.name}`,odds:s,prob:t.placeProb,ev:a,frame1:t.frame,frame2:0,frame3:0,horse1:t.number,horse2:0,horse3:0})})),a.forEach((r=>{const t=e.filter((e=>e.frame===r.frame1)),s=e.filter((e=>e.frame===r.frame2));let a=0;if(r.frame1===r.frame2)for(let e=0;e<t.length;e++)for(let r=e+1;r<t.length;r++){const s=t[e],o=t[r];a+=s.winProb*((o.placeProb-o.winProb)/2),a+=o.winProb*((s.placeProb-s.winProb)/2)}else t.forEach((e=>{s.forEach((r=>{a+=e.winProb*((r.placeProb-r.winProb)/2),a+=r.winProb*((e.placeProb-e.winProb)/2)}))}));const o=r.odds*a;a>0&&o>1&&m.push({type:"枠連",horseName:`${r.frame1}-${r.frame2}`,frame1:r.frame1,frame2:r.frame2,frame3:0,odds:r.odds,prob:a,ev:o,horse1:0,horse2:0,horse3:0})})),o.forEach((r=>{const t=e.find((e=>e.number===r.horse1)),s=e.find((e=>e.number===r.horse2));if(!t||!s)return;let a=0;const o=(s.placeProb-s.winProb)/2;a+=t.winProb*o;const n=(t.placeProb-t.winProb)/2;a+=s.winProb*n;const i=r.odds*a;a>0&&i>1&&m.push({type:"馬連",horseName:`${t.number}-${s.number}`,frame1:t.frame,frame2:s.frame,frame3:0,horse1:t.number,horse2:s.number,horse3:0,odds:r.odds,prob:a,ev:i})})),n.forEach((r=>{const t=e.find((e=>e.number===r.horse1)),s=e.find((e=>e.number===r.horse2));if(!t||!s)return;let a=0;a+=t.winProb*((s.placeProb-s.winProb)/2),a+=t.winProb*((s.placeProb-s.winProb)/2),a+=s.winProb*((t.placeProb-t.winProb)/2),a+=(t.placeProb-t.winProb)/2*((s.placeProb-s.winProb)/2),a+=s.winProb*((t.placeProb-t.winProb)/2),a+=(t.placeProb-t.winProb)/2*((s.placeProb-s.winProb)/2);const o=Math.round((r.oddsMin+r.oddsMax)/2*10)/10,n=o*a;a>0&&n>1&&m.push({type:"ワイド",horseName:`${t.number}-${s.number}`,odds:o,prob:a,ev:n,frame1:t.frame,frame2:s.frame,frame3:0,horse1:t.number,horse2:s.number,horse3:0})})),i.forEach((r=>{const t=e.find((e=>e.number===r.horse1)),s=e.find((e=>e.number===r.horse2));if(!t||!s)return;const a=t.winProb*((s.placeProb-s.winProb)/2),o=r.odds*a;a>0&&o>1&&m.push({type:"馬単",horseName:`${t.number}→${s.number}`,frame1:t.frame,frame2:s.frame,frame3:0,horse1:t.number,horse2:s.number,horse3:0,odds:r.odds,prob:a,ev:o})})),l.forEach((r=>{const t=e.find((e=>e.number===r.horse1)),s=e.find((e=>e.number===r.horse2)),a=e.find((e=>e.number===r.horse3));if(!t||!s||!a)return;let o=0;o+=t.winProb*((s.placeProb-s.winProb)/2)*((a.placeProb-a.winProb)/2),o+=t.winProb*((a.placeProb-a.winProb)/2)*((s.placeProb-s.winProb)/2),o+=s.winProb*((t.placeProb-t.winProb)/2)*((a.placeProb-a.winProb)/2),o+=s.winProb*((a.placeProb-a.winProb)/2)*((t.placeProb-t.winProb)/2),o+=a.winProb*((t.placeProb-t.winProb)/2)*((s.placeProb-s.winProb)/2),o+=a.winProb*((s.placeProb-s.winProb)/2)*((t.placeProb-t.winProb)/2);const n=r.odds*o;o>0&&n>1&&m.push({type:"３連複",horseName:`${t.number}-${s.number}-${a.number}`,frame1:t.frame,frame2:s.frame,frame3:a.frame,horse1:t.number,horse2:s.number,horse3:a.number,odds:r.odds,prob:o,ev:n})})),d.forEach((r=>{const t=e.find((e=>e.number===r.horse1)),s=e.find((e=>e.number===r.horse2)),a=e.find((e=>e.number===r.horse3));if(!t||!s||!a)return;const o=t.winProb*((s.placeProb-s.winProb)/2)*((a.placeProb-a.winProb)/2),n=r.odds*o;o>0&&n>1&&m.push({type:"３連単",horseName:`${t.number}→${s.number}→${a.number}`,frame1:t.frame,frame2:s.frame,frame3:a.frame,horse1:t.number,horse2:s.number,horse3:a.number,odds:r.odds,prob:o,ev:n})})),(e=>{const s=e=>{switch(e){case"単勝":return 2;case"複勝":default:return 1;case"枠連":case"ワイド":return 3;case"馬連":return 5.8;case"馬単":return 10.5;case"３連複":return 12.7;case"３連単":return 59}},a=(e=>{const r=e=>{const r=s(e);return{min:0,max:Math.min(30,Math.ceil(3*Math.sqrt(r)*(1+Math.log10(r)/2)))}},t={"複勝":r("複勝"),"単勝":r("単勝"),"枠連":r("枠連"),"ワイド":r("ワイド"),"馬連":r("馬連"),"馬単":r("馬単"),"３連複":r("３連複"),"３連単":r("３連単")},a=e.reduce(((e,r)=>(e[r.type]||(e[r.type]=[]),e[r.type].push(r),e)),{});let o=[];return Object.entries(a).forEach((([e,r])=>{const s=t[e],a=Math.min(r.length,Math.max(s.min,Math.min(s.max,r.length)));o=o.concat(r.slice(0,a))})),o.sort(((e,r)=>r.ev-e.ev))})(e.filter((e=>{const r=s(e.type),a=Math.max(1,Math.pow(t,.5)*Math.pow(r,.8)),o=Math.max(.001,.1/(t*Math.log10(r+2))),n=Math.max(1,1+Math.log10(r)/Math.pow(t,.5));return e.odds>=a&&e.prob>=o&&e.ev>=n})).sort(((e,r)=>r.ev-e.ev))),o=a.map((()=>1/a.length));return a.map(((e,t)=>({type:e.type,horses:[e.horseName],horseName:e.horseName,stake:Number((r*o[t]).toFixed(1)),expectedReturn:Number((r*o[t]*e.odds).toFixed(1)),probability:e.prob,frame1:e.frame1,frame2:e.frame2,frame3:e.frame3,horse1:e.horse1,horse2:e.horse2,horse3:e.horse3}))).sort(((e,r)=>{const t={"単勝":1,"複勝":2,"枠連":3,"ワイド":4,"馬連":5,"馬単":6,"３連複":7,"３連単":8},s=t[e.type]-t[r.type];return 0!==s?s:r.stake-e.stake}))})(m)})(i.map((e=>{var r;return{name:e.name,odds:Number((null==(r=null==G?void 0:G.find((r=>Number(r.horseId)===e.number)))?void 0:r.odds)||0),winProb:V[e.id]/100,placeProb:D[e.id]/100,frame:e.frame,number:e.number}})),z,U,Z.map((e=>({horse1:Number(e.horseId),oddsMin:Number(e.oddsMin),oddsMax:Number(e.oddsMax)}))),Q.map((e=>({frame1:e.frame1,frame2:e.frame2,odds:Number(e.odds)}))),ee.map((e=>({horse1:Number(e.horse1),horse2:Number(e.horse2),odds:Number(e.odds)}))),re.map((e=>({horse1:Number(e.horse1),horse2:Number(e.horse2),oddsMin:Number(e.oddsMin),oddsMax:Number(e.oddsMax)}))),te.map((e=>({horse1:Number(e.horse1),horse2:Number(e.horse2),odds:Number(e.odds)}))),se.map((e=>({horse1:Number(e.horse1),horse2:Number(e.horse2),horse3:Number(e.horse3),odds:Number(e.odds)}))),ae.map((e=>({horse1:Number(e.horse1),horse2:Number(e.horse2),horse3:Number(e.horse3),odds:Number(e.odds)})))):[],staleTime:6e5,gcTime:601e3}),{data:ne}=c({queryKey:["conditional-probabilities",null==oe?void 0:oe.length],queryFn:()=>p(oe||[],(null==i?void 0:i.map((e=>{var r;return{name:e.name,odds:Number((null==(r=null==G?void 0:G.find((r=>Number(r.horseId)===e.number)))?void 0:r.odds)||0),winProb:V[e.id]/100,placeProb:D[e.id]/100,frame:e.frame,number:e.number}})))||[]),enabled:!!i&&!!(null==oe?void 0:oe.length),staleTime:6e5,gcTime:601e3});e.useEffect((()=>{ne&&j(ne)}),[ne]);const ie=c({queryKey:["gemini-analysis",n,z,U,null==oe?void 0:oe.length,null==ne?void 0:ne.length],queryFn:()=>async function(e){var r,t,s;if(!e.horses||!Array.isArray(e.horses)||0===e.horses.length)throw new Error("出走馬データが無効です");if(!e.bettingOptions||!Array.isArray(e.bettingOptions)||0===e.bettingOptions.length)throw new Error("馬券候補データが無効です");if("number"!=typeof e.budget||e.budget<100||e.budget>1e6)throw new Error("予算が無効です");if("number"!=typeof e.riskRatio||e.riskRatio<2||e.riskRatio>20)throw new Error("リスクリワード比が無効です");const a=e=>e.replace(/[<>]/g,"").replace(/[`'"]/g,"").replace(/[\u0000-\u001F\u007F-\u009F]/g,"").trim(),o=e.horses.sort(((e,r)=>e.number-r.number)).map((e=>{const r=a(e.name);return`${e.frame}枠${e.number}番 ${r.padEnd(20)} 単勝予想${(100*e.winProb).toFixed(1).padStart(4)}%, 複勝予想${(100*e.placeProb).toFixed(1).padStart(4)}%`})).join("\n"),n=["単勝","複勝","枠連","ワイド","馬連","馬単","３連複","３連単"],i=n.map((r=>{const t=e.bettingOptions.filter((e=>e.type===r)).map((e=>{if("number"!=typeof e.expectedReturn||e.expectedReturn<0)throw new Error("期待値が無効です");if("number"!=typeof e.probability||e.probability<0||e.probability>1)throw new Error("確率が無効です");if("number"!=typeof e.stake||e.stake<=0)throw new Error("投資額が無効です");const r=e.probability*e.expectedReturn/e.stake;return`${e.horseName?a(e.horseName):""} [オッズ:${(e.expectedReturn/e.stake).toFixed(1)}, 的中確率:${(100*e.probability).toFixed(1)}%, 期待値:${r.toFixed(2)}]`})).join("\n");return t?`\n${r}候補:\n${t}`:""})).filter((e=>e.length>0)).join("\n");e.correlations&&e.correlations.forEach((e=>{if("number"!=typeof e.probability||e.probability<0||e.probability>1)throw new Error("条件付き確率が無効です");if(!n.includes(e.condition.type)||!n.includes(e.target.type))throw new Error("無効な券種が指定されています")}));const l={"単勝":1,"複勝":2,"枠連":3,"ワイド":4,"馬連":5,"馬単":6,"３連複":7,"３連単":8},d=`\n# 競馬分析プロンプト\n\nあなたは競馬分析の専門家で、プロの馬券アナリストとして行動してください。あなたの目標は、ユーザーにとって最も価値のある馬券購入戦略を導き出すことです。\n\n## 1. 分析プロセス\n- まず出馬表からユーザー予想確率を分析し、市場の認識と比較して割高/割安な馬を特定する\n- 次に馬券候補リストから期待値の高い馬券を抽出し、その理由を明確に説明する\n- 条件付き確率データを用いて、組み合わせ馬券の相関性を分析し、効率的な馬券組み合わせを発見する\n- 最終的に3つの具体的な馬券戦略を提案し、それぞれの論理的根拠を示す\n\n## 2. 出力フォーマット\n以下の構造に厳密に従ったJSONを返してください：\n{\n  "summary": {\n    "marketAnalysis": "全体的な市場分析の要約（100字以内）",\n    "keyInsights": [\n      {\n        "strategy": "馬券戦略1の名称",\n        "details": "馬券戦略1の詳細説明と根拠",\n        "expectedValue": "期待値の数値と簡潔な説明",\n        "riskLevel": "低/中/高のリスク評価"\n      },\n      {\n        "strategy": "馬券戦略2の名称",\n        "details": "馬券戦略2の詳細説明と根拠",\n        "expectedValue": "期待値の数値と簡潔な説明",\n        "riskLevel": "低/中/高のリスク評価"\n      },\n      {\n        "strategy": "馬券戦略3の名称",\n        "details": "馬券戦略3の詳細説明と根拠",\n        "expectedValue": "期待値の数値と簡潔な説明",\n        "riskLevel": "低/中/高のリスク評価"\n      }\n    ]\n  }\n}\n\n## 3. 分析対象データ\n【出馬表】\n${o}\n\n【馬券候補】\n${i}\n\n【条件付き確率】\n${(null==(r=e.correlations)?void 0:r.sort(((r,t)=>{const s=l[r.condition.type]||999,a=l[t.condition.type]||999;if(s!==a)return s-a;const o=r=>{const t=e.bettingOptions.find((e=>e.type===r.type&&e.horseName===r.horses));return t?t.probability*t.expectedReturn/t.stake:-1},n=o(r.condition),i=o(t.condition);return n!==i?i-n:r.condition.horses.localeCompare(t.condition.horses)})).reduce(((e,r,t,s)=>(0!==t&&s[t-1].condition.type===r.condition.type&&s[t-1].condition.horses===r.condition.horses||e.push(`\n■ ${r.condition.type}[${r.condition.horses}]が的中した場合：`),e.push(`・${r.target.type}[${r.target.horses}]の的中確率は${(100*r.probability).toFixed(1)}%`),e)),[]).join("\n"))||"条件付き確率データなし"}\n\n## 4. 分析の制約条件\n- リスク分散のため、異なるタイプの馬券（単勝/複勝/馬連など）を含めることが望ましい\n- 提案する戦略は具体的な馬番を含むこと\n- 分析結果は客観的なデータに基づくものであり、「絶対に当たる」などの断定的表現は避ける\n\n## 5. 思考プロセス\n以下のステップで思考を進めてください：\na) 予想確率とオッズの乖離から割安な馬を特定\nb) 的中確率と期待値のバランスを考慮した馬券候補のランク付け\nc) 条件付き確率から相関性の高い/低い組み合わせを発見\nd) 上記分析を総合した最適な馬券戦略の構築\n\nそれぞれのステップでの考察を明示した上で最終的な戦略を提案してください。\n\n`,m="gemini_analysis_last_request",c=Number(localStorage.getItem(m))||0,h=Date.now();if(h-c<1e3)throw new Error("リクエストが頻繁すぎます。しばらく待ってから再試行してください。");localStorage.setItem(m,String(h));const u=await(async(e,r,t=5)=>{const s=e=>Math.min(1e3*Math.pow(2,e),1e4)+1e3*Math.random();for(let o=0;o<t;o++)try{const t=await fetch(e,{...r,headers:{...r.headers,"X-Requested-With":"XMLHttpRequest"}});if(503===t.status){await new Promise((e=>setTimeout(e,s(o))));continue}if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t}catch(a){if(o===t-1)throw a;await new Promise((e=>setTimeout(e,s(o))))}throw new Error("リクエストが失敗しました")})("/api/gemini",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":_(),"Cache-Control":"no-cache","X-Force-Refresh":"true"},credentials:"same-origin",body:JSON.stringify({prompt:d,model:"gemini-2.0-flash-001",thought:!1,apiVersion:"v1alpha",maxTokens:2048,raceId:e.raceId,settings:{horses:e.horses.map((e=>e.number)),budget:e.budget,riskRatio:e.riskRatio}})});if(!u)throw new Error("分析結果の取得に失敗しました");const b=await u.json();try{const e=/```(?:json)?\s*\n([\s\S]*?)\n```/.exec(b.strategy.description);if(!e||!e[1])throw new Error("JSONコードブロックが見つかりません");let r;try{r=JSON.parse(e[1])}catch(p){throw new Error("JSONのパースに失敗しました")}if(!(null==(s=null==(t=r.summary)?void 0:t.keyInsights)?void 0:s.length))throw new Error("レスポンスの構造が不正です");return{summary:{marketAnalysis:r.summary.marketAnalysis,keyInsights:Array.isArray(r.summary.keyInsights)?r.summary.keyInsights.map((e=>"string"==typeof e?e:{strategy:e.strategy||"",details:e.details||"",expectedValue:e.expectedValue||"",riskLevel:e.riskLevel||""})):["分析結果の取得に失敗しました。"]}}}catch(f){return{summary:{keyInsights:["分析結果の処理中にエラーが発生しました。"]}}}}({horses:(null==i?void 0:i.map((e=>{var r;return{name:e.name,odds:Number((null==(r=null==G?void 0:G.find((r=>Number(r.horseId)===e.number)))?void 0:r.odds)||0),winProb:V[e.id]/100,placeProb:D[e.id]/100,frame:e.frame,number:e.number}})))||[],bettingOptions:oe||[],budget:z,riskRatio:U,correlations:ne||[],raceId:n||""}),enabled:!!i&&!!(null==oe?void 0:oe.length)&&!!(null==ne?void 0:ne.length)});e.useEffect((()=>{Y&&l(Y)}),[Y,l]),e.useEffect((()=>{oe&&b(oe)}),[oe,b]),e.useEffect((()=>{ie.data&&u(ie.data)}),[ie.data,u]),e.useEffect((()=>{if(oe&&oe.length>0){const e={},r={};oe.forEach((t=>{"単勝"===t.type&&t.horse1&&(e[t.horse1]=100*t.probability),"複勝"===t.type&&t.horse1&&(r[t.horse1]=100*t.probability)})),k(e),$(r)}}),[oe,k,$]);const le=e.useMemo((()=>[{id:"settings",title:"予想設定",icon:r.jsx(A,{className:"h-5 w-5"}),component:r.jsx(W,{budget:z,riskRatio:U,horses:i||[],winProbs:V,placeProbs:D})},{id:"analysis",title:"分析結果",icon:r.jsx(T,{className:"h-5 w-5"}),component:r.jsx(X,{isLoading:ie.isLoading,data:ie.data})}]),[z,U,i,V,D,ie.isLoading,ie.data]);return H?r.jsxs(S,{variant:"destructive",children:[r.jsx(B,{className:"h-4 w-4"}),r.jsx(R,{children:"データの取得に失敗しました。"})]}):r.jsx("div",{className:"relative",children:r.jsxs("div",{className:"flex",children:[r.jsx("div",{className:I("transition-all duration-300 ease-in-out w-full",M?"lg:w-2/3 xl:w-3/4":"w-full"),children:r.jsxs("div",{className:"space-y-2",children:[r.jsx("div",{className:"flex justify-end p-2",children:r.jsx(L,{variant:"outline",size:"sm",onClick:()=>E(!M),className:"flex items-center gap-1",children:M?r.jsxs(r.Fragment,{children:[r.jsx(F,{className:"h-4 w-4"}),r.jsx("span",{className:"hidden sm:inline",children:"閉じる"})]}):r.jsxs(r.Fragment,{children:[r.jsx(C,{className:"h-4 w-4"}),r.jsx("span",{className:"inline",children:"予想設定とAI分析"})]})})}),r.jsx(f,{bettingOptions:oe||[],selectedBets:[],correlations:P,className:"[&_tr:hover]:bg-transparent",showAnalysis:!0,columnsCount:4})]})}),r.jsxs("div",{className:I("fixed lg:relative right-0 top-0 h-full lg:h-auto z-50 bg-background/95 backdrop-blur-sm border-l border-border/50 transition-all duration-300 ease-in-out overflow-hidden",M?"translate-x-0 w-full sm:w-96 lg:w-1/3 xl:w-1/4":"translate-x-full w-full sm:w-96 lg:translate-x-full lg:w-0 lg:opacity-0 lg:invisible"),children:[r.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border/50",children:[r.jsx("div",{className:"flex items-center gap-2",children:le.map((e=>r.jsxs(L,{variant:O===e.id?"default":"ghost",size:"sm",onClick:()=>q(e.id),className:"gap-1",children:[e.icon,r.jsx("span",{className:"inline",children:e.title})]},e.id)))}),r.jsx(L,{variant:"ghost",size:"icon",onClick:()=>E(!1),className:"text-muted-foreground hover:text-foreground",children:r.jsx(F,{className:"h-5 w-5"})})]}),r.jsx("div",{className:"p-4 overflow-y-auto h-[calc(100%-4rem)]",children:null==(o=le.find((e=>e.id===O)))?void 0:o.component})]})]})})}const H=async(e,r,t=[])=>{const s=e.map((e=>({...e,probability:D(e.probability)}))),a=new Map;t.forEach((e=>{const r=`${e.condition.type}:${e.condition.horses}|${e.target.type}:${e.target.horses}`;a.set(r,e.probability)}));const o=(e,r)=>{if(e.type===r.type){if(["単勝","枠連","馬連","馬単","３連複","３連単"].includes(e.type))return 1;if("複勝"===e.type)return e.horses.some((e=>r.horses.includes(e)))?1:.4;if("ワイド"===e.type){const t=e.horses.filter((e=>r.horses.includes(e)));if(2===t.length||0===t.length)return 1;if(1===t.length)return.4}}return 0===e.horses.filter((e=>r.horses.includes(e))).length?0:"単勝"===e.type||"単勝"===r.type?.8:"複勝"===e.type||"複勝"===r.type?.4:.6},n=e=>{const r=e.map(((r,t)=>{const n=s[t],i=n.odds*n.probability;let l=1,d=!1;return e.forEach(((e,r)=>{if(t!==r&&e>0){const e=s[r],t=`${e.type}:${e.horses.join("-")}|${n.type}:${n.horses.join("-")}`,i=`${n.type}:${n.horses.join("-")}|${e.type}:${e.horses.join("-")}`;let m=a.get(t);if(void 0===m&&(m=a.get(i)),void 0!==m)d=!0,l*=1-e.probability*(1-m);else{const r=o(n,e);l*=1-e.probability*r}}})),{return:r*i*l*3,condProbUsed:d}})),t=r.reduce(((e,r)=>e+r.return),0),n=r.filter((e=>e.condProbUsed)).length,i=e.map(((r,t)=>{const n=s[t],i=(n.odds-1)*r;let l=n.probability;return e.forEach(((e,r)=>{if(t!==r&&e>0){const e=s[r],t=`${e.type}:${e.horses.join("-")}|${n.type}:${n.horses.join("-")}`;let i=a.get(t);void 0===i&&(i=1-o(n,e)),l*=1-e.probability*(1-i)}})),l*(1-l)*i*i*.5})).reduce(((e,r)=>e+r),0),l=Math.sqrt(i);return{sharpeRatio:l>0?t/l:0,expectedReturn:t,risk:l,condProbUsedCount:n}},i=Math.min(4,Math.ceil(s.length/5)),l=Array(i).fill(0).map((async(e,r)=>{const t=1+.1*r,a=.995-.001*r;let o=[],i={sharpeRatio:-1/0,expectedReturn:0,risk:0,condProbUsedCount:0};const l=Math.min(5+Math.floor(s.length/3),10);for(let d=0;d<l;d++){let e=d%3==0?s.map((e=>e.probability*e.odds)):d%3==1?s.map((e=>e.probability)):Array(s.length).fill(0).map((()=>Math.random()));e=e.map(((e,r,t)=>e/t.reduce(((e,r)=>e+r),0)));let r=n(e),l=t;for(;l>.001;){const t=[...e],d=Math.floor(Math.random()*t.length);let m=Math.floor(Math.random()*t.length);for(;m===d;)m=Math.floor(Math.random()*t.length);const c=Math.random()*l*.1;t[d]>c&&(t[d]-=c,t[m]+=c);const h=n(t),u=h.sharpeRatio-r.sharpeRatio;if((u>0||Math.random()<Math.exp(u/l))&&(e=t,r=h,r.sharpeRatio>i.sharpeRatio&&(i=r,o=[...e])),Math.random()<.05){const t=Math.random();if(t<.33){const r=e.map(((e,r)=>({weight:e,index:r,ev:s[r].probability*s[r].odds}))).sort(((e,r)=>r.ev-e.ev)).map((e=>e.index)),t=[...e].map((()=>0)),a=Math.max(2,Math.floor(.3*e.length));for(let e=0;e<a;e++)t[r[e]]=1/a;e=t}else e=t<.66?Array(e.length).fill(0).map((()=>Math.random())).map(((e,r,t)=>e/t.reduce(((e,r)=>e+r),0))):e.map((e=>e*(.5+Math.random()))).map(((e,r,t)=>e/t.reduce(((e,r)=>e+r),0)));r=n(e)}l*=a}}return{bestWeights:o,bestMetrics:i}})),d=await Promise.all(l),m=d.reduce(((e,r)=>r.bestMetrics.sharpeRatio>e.bestMetrics.sharpeRatio?r:e),d[0]);let c=m.bestWeights;m.bestMetrics;let h=s.map(((e,t)=>{const s=e.odds;return{type:e.type,horses:e.horses,horseName:["馬単","３連単"].includes(e.type)?e.horses.join("→"):e.horses.join("-"),stake:100*Math.floor(r*c[t]/100),odds:s,expectedReturn:s*Math.floor(r*c[t]/100)*100,probability:e.probability,reason:e.reason,frame1:e.frame1,frame2:e.frame2,frame3:e.frame3,horse1:e.horse1,horse2:e.horse2,horse3:e.horse3}})).filter((e=>e.stake>=100)).sort(((e,r)=>{const t={"単勝":1,"複勝":2,"枠連":3,"ワイド":4,"馬連":5,"馬単":6,"３連複":7,"３連単":8},s=t[e.type]-t[r.type];return 0!==s?s:r.stake-e.stake}));const u=h.reduce(((e,r)=>e+r.stake),0);if(u<r){const e=r-u,t=Math.floor(e/100),s=[...h].map(((e,r)=>({index:r,expectedValue:e.probability*e.odds}))).sort(((e,r)=>r.expectedValue-e.expectedValue));for(let r=0;r<t;r++){const e=s[r%s.length].index;h[e].stake+=100,h[e].expectedReturn=h[e].odds*h[e].stake}h.forEach((e=>{e.odds=e.expectedReturn/e.stake}))}return h};function G(){s();const[t,a]=d(P),[o]=d(y),[n]=d(g),[i]=d(k),[l,c]=d(v),[u,b]=d(N),p=m(w),x=Number(new URLSearchParams(window.location.search).get("budget"))||1e4,E=Number(new URLSearchParams(window.location.search).get("risk"))||1,[O,S]=d($);return e.useEffect((()=>{"PORTFOLIO"===O&&t.selectedBets.length>0&&!t.isAiOptimized&&(async()=>{try{const e=t.selectedBets.map((e=>({type:e.type,horses:e.horses,odds:e.odds||e.expectedReturn/e.stake,probability:e.probability,reason:e.reason||"手動選択された馬券",frame1:e.frame1,frame2:e.frame2,frame3:e.frame3,horse1:e.horse1,horse2:e.horse2,horse3:e.horse3}))),r=await H(e,x,p);a((e=>({...e,selectedBets:r})))}catch(e){h().set(M,{step:-1,message:"エラーが発生しました",error:e.message})}})()}),[O,t.selectedBets.length,t.isAiOptimized,x,a,p]),e.useEffect((()=>{"SELECTION"===O&&t.isAiOptimized&&a((e=>({...e,isAiOptimized:!1})))}),[O,t.isAiOptimized,a]),e.useEffect((()=>{const e=new URLSearchParams(window.location.search),r=e.get("winProbs"),t=e.get("placeProbs");try{if(r){const e=JSON.parse(r);c(e)}if(t){const e=JSON.parse(t);b(e)}}catch(s){}}),[c,b]),r.jsxs("div",{className:"relative min-h-screen",children:[r.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[r.jsxs(L,{onClick:async()=>{try{if(S("PORTFOLIO"),!n||!o)throw new Error("データが読み込まれていません");const e=n.map((e=>{var r;const t=String(e.id),s=(l[t]||0)/100,a=(u[t]||0)/100,n=o.find((r=>"単勝"===r.type&&r.horse1===e.number)),d=o.find((r=>"複勝"===r.type&&r.horse1===e.number)),m=s||(null==n?void 0:n.probability)||0,c=a||(null==d?void 0:d.probability)||0,h=Math.max(c,m);return{number:e.number,name:e.name,winProb:m,placeProb:h,odds:Number((null==(r=null==i?void 0:i.find((r=>Number(r.horseId)===e.number)))?void 0:r.odds)||0),frame:e.frame}})),r=await(async(e,r,t,s)=>{var a;try{const o=t.bettingOptions.map((e=>({type:e.type,horseName:`${e.horse1}${e.horse2?`-${e.horse2}`:""}${e.horse3?`-${e.horse3}`:""}`,odds:e.odds,probability:String(e.prob),expectedValue:String(e.ev)}))),n={horses:e.map((e=>({name:e.name,odds:e.odds,winProb:e.winProb,placeProb:e.placeProb,frame:e.frame,number:e.number}))),bettingOptions:t.bettingOptions,conditionalProbabilities:t.conditionalProbabilities||[],raceId:"default-race-id"},i=await j(o,r,n,s);if(!(null==(a=null==i?void 0:i.strategy)?void 0:a.recommendations))throw new Error("Gemini APIからの応答が不正です");const l=i.strategy.recommendations.map((e=>({...e,probability:D(e.probability)})));return await H(l,r,t.conditionalProbabilities||[])}catch(o){throw new Error(`馬券最適化に失敗しました: ${o.message}`)}})(e,x,{bettingOptions:o.map((e=>({type:e.type,horseName:e.horseName,odds:e.expectedReturn/e.stake,prob:e.probability,ev:e.probability*e.expectedReturn/e.stake,frame1:e.frame1||0,frame2:e.frame2||0,frame3:e.frame3||0,horse1:e.horse1||0,horse2:e.horse2||0,horse3:e.horse3||0}))),conditionalProbabilities:p},E),t=r.map(((e,r)=>({...e})));a((e=>({...e,selectedBets:t,isAiOptimized:!0})))}catch(e){}},className:"w-full gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700",children:[r.jsx(q,{className:"h-4 w-4"}),"AI自動最適化"]}),r.jsxs(L,{onClick:async()=>{if(t.selectedBets.length>0&&!t.isAiOptimized)try{S("PORTFOLIO"),await new Promise((e=>setTimeout(e,100))),h().set(M,{step:3,message:"資金配分最適化中...",error:null});const e=t.selectedBets.map((e=>({type:e.type,horses:e.horses,odds:e.odds||e.expectedReturn/e.stake,probability:e.probability,reason:e.reason||"手動選択された馬券",frame1:e.frame1,frame2:e.frame2,frame3:e.frame3,horse1:e.horse1,horse2:e.horse2,horse3:e.horse3}))),r=await H(e,x,p);a((e=>({...e,selectedBets:r})))}catch(e){h().set(M,{step:-1,message:"エラーが発生しました",error:e.message})}},disabled:0===t.selectedBets.length,className:`\n            w-full gap-2 bg-gradient-to-r from-blue-600 to-cyan-600 \n            hover:from-blue-700 hover:to-cyan-700\n            transition-opacity duration-300\n            ${0===t.selectedBets.length?"opacity-50 cursor-not-allowed":""}\n          `,children:[r.jsx(z,{className:"h-4 w-4"}),"資金配分最適化"]})]}),r.jsx("div",{children:r.jsx(f,{bettingOptions:o,selectedBets:t.selectedBets,onBetSelect:e=>{const r=e=>e.includes(" ")?e.split(" ")[0]:e,s=t.selectedBets.some((t=>t.type===e.type&&r(t.horseName||"")===r(e.horseName||"")));a((t=>{if(s){const s=t.selectedBets.filter((t=>!(t.type===e.type&&r(t.horseName||"")===r(e.horseName||""))));return{...t,selectedBets:s}}return{...t,selectedBets:[...t.selectedBets,e]}}))},onSelectAllByType:(e,r)=>{a((t=>{const s=[...t.selectedBets];if(r){const r=o.filter((r=>r.type===e)).filter((e=>!s.some((r=>r.type===e.type&&r.horseName===e.horseName))));return{...t,selectedBets:[...s,...r]}}return{...t,selectedBets:s.filter((r=>r.type!==e))}}))},horses:(n||[]).map((e=>{var r;const t=String(e.id),s=(l[t]||0)/100,a=(u[t]||0)/100,n=o.find((r=>"単勝"===r.type&&r.horse1===e.number)),d=o.find((r=>"複勝"===r.type&&r.horse1===e.number)),m=s||(null==n?void 0:n.probability)||0,c=a||(null==d?void 0:d.probability)||0,h=Math.max(c,m);return{number:e.number,name:e.name,winProb:m,placeProb:h,odds:Number((null==(r=null==i?void 0:i.find((r=>Number(r.horseId)===e.number)))?void 0:r.odds)||0),frame:e.frame}})),correlations:p,columnsCount:4})})]})}const Z=e.forwardRef((({className:e,value:t,...s},a)=>r.jsx(U,{ref:a,className:I("relative h-4 w-full overflow-hidden rounded-full bg-secondary",e),...s,children:r.jsx(K,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(t||0)}%)`}})})));function Q(){const[t]=d(P),[s]=d(M),a=Number(new URLSearchParams(window.location.search).get("budget"))||1e4,[o,n]=e.useState(!0),i=e.useMemo((()=>{if(!t.selectedBets.length)return{description:"選択された馬券がありません",recommendations:[],summary:{riskLevel:t.isAiOptimized?"AI_OPTIMIZED":"USER_SELECTED",description:""},bettingTable:{headers:["券種","買い目","オッズ","的中率","投資額","理由"],rows:[]}};const e=t.selectedBets.map((e=>({type:e.type,horses:e.horses,odds:e.odds||e.expectedReturn/e.stake,probability:D(e.probability),reason:e.reason||"理由なし",frame1:e.frame1,frame2:e.frame2,frame3:e.frame3,horse1:e.horse1,horse2:e.horse2,horse3:e.horse3,stake:e.stake,expectedReturn:e.expectedReturn})));return{description:(t.isAiOptimized,"購入予定"),recommendations:e,summary:{riskLevel:t.isAiOptimized?"AI_OPTIMIZED":"USER_SELECTED",description:t.isAiOptimized?"AIが選択した馬券の最適な組み合わせです":"ユーザーが選択した馬券の最適な資金配分です"},bettingTable:{headers:["券種","買い目","オッズ","的中率","投資額","理由"],rows:e.map((r=>[r.type,r.horses.join("-"),r.odds.toFixed(1),"number"==typeof r.probability?`${(100*r.probability).toFixed(1)}%`:r.probability,r.stake?r.stake.toLocaleString():Math.round(a*(1/e.length)).toLocaleString(),r.reason]))}}}),[t.selectedBets,t.isAiOptimized,a]);if(e.useEffect((()=>{if(t.selectedBets.length>0&&(!t.isAiOptimized||3===s.step)){const e=setTimeout((()=>{n(!1)}),800);return()=>clearTimeout(e)}}),[t.selectedBets,t.isAiOptimized,s.step]),o){const e=100*s.step/3;return r.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[50vh]",children:[r.jsx(J,{className:"h-12 w-12 text-primary animate-spin mb-4"}),r.jsx("p",{className:"text-muted-foreground mb-4",children:s.message||"ポートフォリオを最適化中..."}),r.jsx("div",{className:"w-full max-w-md mb-2",children:r.jsx(Z,{value:e,className:"h-2"})}),r.jsxs("p",{className:"text-xs text-muted-foreground",children:["ステップ ",s.step,"/3: ",ee(s.step)]}),s.error&&r.jsx("div",{className:"mt-4 p-3 bg-destructive/10 text-destructive rounded-md",children:s.error})]})}return i.recommendations.length?r.jsx("div",{className:"space-y-6",children:r.jsx(E,{strategy:i,totalBudget:a})}):r.jsx("div",{className:"text-center text-muted-foreground p-4",children:"馬券が選択されていません"})}function ee(e){switch(e){case 0:return"準備中";case 1:return"馬券間の相関関係とリスク分析";case 2:return"投資設定に基づく購入戦略策定";case 3:return"最適な資金配分";default:return"処理中"}}function re({onBackToPrediction:e}){const[t,s]=d($),[a]=d(O),o=[{id:"ANALYSIS",label:"分析",description:"期待値・リスク分析"},{id:"SELECTION",label:"選択",description:"購入馬券の選択"},{id:"PORTFOLIO",label:"買い目",description:"資金配分最適化"}],n=o.findIndex((e=>e.id===t));return r.jsxs("div",{className:"w-full space-y-8",children:[r.jsxs("div",{className:"relative",children:[r.jsx("div",{className:"absolute top-1/2 left-0 right-0 h-0.5 bg-gradient-to-r from-border/50 via-border to-border/50 -translate-y-1/2"}),r.jsx("div",{className:"relative flex justify-between",children:o.map(((e,t)=>{const s=t===n,a=t<n;return r.jsxs("div",{className:"flex flex-col items-center",children:[r.jsxs("div",{className:`\n                    w-10 h-10 rounded-full flex items-center justify-center relative z-10\n                    transition-all duration-300 ease-out\n                    ${s?"bg-gradient-to-br from-primary to-primary/80 text-primary-foreground scale-110 shadow-lg shadow-primary/20":a?"bg-gradient-to-br from-primary/80 to-primary/60 text-primary-foreground":"bg-gradient-to-br from-muted/80 to-muted text-muted-foreground"}\n                  `,children:[r.jsx("span",{className:"font-medium",children:t+1}),s&&r.jsx("div",{className:"absolute inset-0 rounded-full animate-ping bg-primary/20",style:{animationDuration:"2s"}})]}),r.jsxs("div",{className:"mt-3 text-center",children:[r.jsx("div",{className:`\n                    font-medium transition-colors duration-300\n                    ${s?"text-primary":a?"text-foreground/80":"text-muted-foreground"}\n                  `,children:e.label}),r.jsx("div",{className:`\n                    text-xs transition-colors duration-300 max-w-[120px] text-center\n                    ${s?"text-foreground/70":"text-muted-foreground"}\n                  `,children:e.description})]})]},e.id)}))})]}),r.jsxs("div",{className:"flex justify-between mt-8",children:["ANALYSIS"===t&&e&&r.jsxs(L,{variant:"outline",size:"default",onClick:e,className:"flex items-center gap-1 text-primary hover:text-primary-foreground hover:bg-primary transition-colors border-primary/30 hover:border-primary",children:[r.jsx(V,{className:"h-4 w-4"}),r.jsx(A,{className:"h-4 w-4 mr-0.5"}),r.jsx("span",{className:"font-medium",children:"予想設定に戻る"})]}),"ANALYSIS"!==t&&r.jsxs(L,{variant:"outline",onClick:()=>{n>0&&s(o[n-1].id)},disabled:0===n,className:`\n              gap-2 transition-all duration-300\n              ${0===n?"opacity-50":"hover:bg-primary/5"}\n            `,children:[r.jsx(C,{className:"h-4 w-4"}),"戻る"]}),"ANALYSIS"===t&&!e&&r.jsx("div",{}),"SELECTION"!==t&&"PORTFOLIO"!==t&&r.jsxs(L,{onClick:()=>{n<o.length-1&&a&&s(o[n+1].id)},disabled:!a||n===o.length-1,className:`\n              gap-2 transition-all duration-300\n              ${a&&n!==o.length-1?"bg-gradient-to-r from-primary to-primary/90 hover:from-primary/90 hover:to-primary":"opacity-50"}\n            `,children:["次へ",r.jsx(F,{className:"h-4 w-4"})]})]})]})}function te(){const{id:e}=t(),[a]=d($),[,o]=s(),{data:n}=c({queryKey:[`/api/races/${e}`],enabled:!!e});return e?r.jsx(l,{children:r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{className:"relative overflow-hidden rounded-xl border border-border/50 bg-gradient-to-br from-card/50 via-card/30 to-card/20 backdrop-blur-sm shadow-sm",children:[r.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-primary/5 via-transparent to-transparent"}),r.jsx("div",{className:"relative p-6",children:r.jsx("div",{className:"flex items-center justify-between",children:r.jsxs("div",{className:"space-y-1",children:[r.jsx("h2",{className:"text-2xl font-bold tracking-tight bg-gradient-to-br from-foreground to-foreground/70 bg-clip-text text-transparent",children:(null==n?void 0:n.name)||"レース名を読み込み中..."}),r.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-2",children:[r.jsx("span",{className:"inline-block w-2 h-2 rounded-full bg-primary/80 animate-pulse"}),(null==n?void 0:n.startTime)?u(new Date(n.startTime),"yyyy年M月d日 HH:mm"):"読み込み中..."," 発走"]})]})})})]}),r.jsxs("div",{className:"container mx-auto py-6 space-y-6",children:[r.jsx(re,{onBackToPrediction:()=>{const r=new URLSearchParams(window.location.search),t=r.get("budget"),s=r.get("risk"),a=r.get("winProbs"),n=r.get("placeProbs"),i=a?encodeURIComponent(a):"",l=n?encodeURIComponent(n):"";o(`/predict/${e}?budget=${t||""}&risk=${s||""}&winProbs=${i}&placeProbs=${l}`)}}),r.jsxs("div",{className:"mt-6",children:["ANALYSIS"===a&&r.jsx(Y,{}),"SELECTION"===a&&r.jsx(G,{}),"PORTFOLIO"===a&&r.jsx(Q,{})]})]})]})}):r.jsx(l,{children:r.jsxs(S,{variant:"destructive",children:[r.jsx(B,{className:"h-4 w-4"}),r.jsx(R,{children:"レースIDが指定されていません。"})]})})}Z.displayName=U.displayName;export{te as BettingStrategy};
